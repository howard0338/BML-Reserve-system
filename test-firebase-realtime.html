<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Realtime Database æ¸¬è©¦</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .status { padding: 15px; margin: 10px 0; border-radius: 5px; font-weight: bold; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        #log { background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 20px; font-family: monospace; white-space: pre-wrap; max-height: 500px; overflow-y: auto; }
        .data-display { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>ğŸ”¥ Firebase Realtime Database æ¸¬è©¦</h1>
    
    <div id="status" class="status info">æº–å‚™ä¸­...</div>
    
    <div>
        <button onclick="testConnection()">ğŸ”— æ¸¬è©¦é€£æ¥</button>
        <button onclick="writeTestData()">âœï¸ å¯«å…¥æ¸¬è©¦è³‡æ–™</button>
        <button onclick="readTestData()">ğŸ“– è®€å–æ¸¬è©¦è³‡æ–™</button>
        <button onclick="listenToData()">ğŸ‘‚ ç›£è½è³‡æ–™è®ŠåŒ–</button>
        <button onclick="clearLog()">ğŸ—‘ï¸ æ¸…é™¤æ—¥èªŒ</button>
    </div>
    
    <div id="dataDisplay" class="data-display">
        <h3>ğŸ“Š è³‡æ–™é¡¯ç¤ºå€åŸŸ</h3>
        <div id="dataContent">ç­‰å¾…è³‡æ–™...</div>
    </div>
    
    <div id="log"></div>

    <script type="module">
        import { 
            db, 
            auth, 
            ref, 
            set, 
            get, 
            onValue, 
            push, 
            remove, 
            signInAnonymously, 
            onAuthStateChanged,
            writeReservation,
            readAllReservations,
            listenToReservations,
            writeInstruments,
            readInstruments,
            listenToInstruments
        } from './firebase.js';

        let unsubscribeReservations = null;
        let unsubscribeInstruments = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            logDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        function displayData(data, title) {
            const dataContent = document.getElementById('dataContent');
            dataContent.innerHTML = `
                <h4>${title}</h4>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
        }

        async function testConnection() {
            try {
                log('é–‹å§‹æ¸¬è©¦Firebaseé€£æ¥...');
                updateStatus('æ¸¬è©¦é€£æ¥ä¸­...', 'info');

                // æ¸¬è©¦èªè­‰
                const user = await new Promise((resolve, reject) => {
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            resolve(user);
                        } else {
                            signInAnonymously(auth).then(() => {
                                // ç­‰å¾…èªè­‰å®Œæˆ
                                setTimeout(() => {
                                    onAuthStateChanged(auth, (user) => {
                                        if (user) resolve(user);
                                        else reject(new Error('èªè­‰å¤±æ•—'));
                                    });
                                }, 1000);
                            }).catch(reject);
                        }
                    });
                });

                log(`èªè­‰æˆåŠŸï¼ç”¨æˆ¶ID: ${user.uid}`, 'success');
                
                // æ¸¬è©¦è³‡æ–™åº«é€£æ¥
                const testRef = ref(db, 'test');
                await set(testRef, { 
                    message: 'Hello Firebase!', 
                    timestamp: new Date().toISOString(),
                    user: user.uid 
                });
                
                const snapshot = await get(testRef);
                if (snapshot.exists()) {
                    log('è³‡æ–™åº«é€£æ¥æˆåŠŸï¼', 'success');
                    displayData(snapshot.val(), 'æ¸¬è©¦è³‡æ–™');
                    updateStatus('âœ… Firebaseé€£æ¥æ­£å¸¸', 'success');
                } else {
                    throw new Error('ç„¡æ³•è®€å–æ¸¬è©¦è³‡æ–™');
                }

            } catch (error) {
                log(`é€£æ¥æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                updateStatus('âŒ Firebaseé€£æ¥å¤±æ•—', 'error');
            }
        }

        async function writeTestData() {
            try {
                log('é–‹å§‹å¯«å…¥æ¸¬è©¦è³‡æ–™...');
                updateStatus('å¯«å…¥è³‡æ–™ä¸­...', 'info');

                // å¯«å…¥æ¸¬è©¦é ç´„
                const reservationData = {
                    instrument: 'æ¸¬è©¦å„€å™¨',
                    date: new Date().toISOString().split('T')[0],
                    timeSlot: 'ä¸Šåˆ',
                    contactName: 'æ¸¬è©¦ç”¨æˆ¶',
                    contactPhone: '0912345678',
                    notes: 'é€™æ˜¯ä¸€å€‹æ¸¬è©¦é ç´„'
                };

                const reservationId = await writeReservation(reservationData);
                log(`é ç´„è³‡æ–™å·²å¯«å…¥ï¼ŒID: ${reservationId}`, 'success');

                // å¯«å…¥æ¸¬è©¦å„€å™¨
                const instrumentsData = [
                    {
                        id: 'test-1',
                        name: 'æ¸¬è©¦å„€å™¨1',
                        location: 'æ¸¬è©¦å¯¦é©—å®¤A',
                        status: 'available'
                    },
                    {
                        id: 'test-2',
                        name: 'æ¸¬è©¦å„€å™¨2',
                        location: 'æ¸¬è©¦å¯¦é©—å®¤B',
                        status: 'available'
                    }
                ];

                await writeInstruments(instrumentsData);
                log('å„€å™¨è³‡æ–™å·²å¯«å…¥', 'success');

                updateStatus('âœ… æ¸¬è©¦è³‡æ–™å¯«å…¥æˆåŠŸ', 'success');

            } catch (error) {
                log(`å¯«å…¥æ¸¬è©¦è³‡æ–™å¤±æ•—: ${error.message}`, 'error');
                updateStatus('âŒ å¯«å…¥è³‡æ–™å¤±æ•—', 'error');
            }
        }

        async function readTestData() {
            try {
                log('é–‹å§‹è®€å–æ¸¬è©¦è³‡æ–™...');
                updateStatus('è®€å–è³‡æ–™ä¸­...', 'info');

                // è®€å–é ç´„è³‡æ–™
                const reservations = await readAllReservations();
                log('é ç´„è³‡æ–™è®€å–å®Œæˆ', 'success');
                displayData(reservations, 'é ç´„è³‡æ–™');

                // è®€å–å„€å™¨è³‡æ–™
                const instruments = await readInstruments();
                log('å„€å™¨è³‡æ–™è®€å–å®Œæˆ', 'success');

                updateStatus('âœ… è³‡æ–™è®€å–æˆåŠŸ', 'success');

            } catch (error) {
                log(`è®€å–æ¸¬è©¦è³‡æ–™å¤±æ•—: ${error.message}`, 'error');
                updateStatus('âŒ è®€å–è³‡æ–™å¤±æ•—', 'error');
            }
        }

        function listenToData() {
            try {
                log('é–‹å§‹ç›£è½è³‡æ–™è®ŠåŒ–...');
                updateStatus('ç›£è½è³‡æ–™ä¸­...', 'info');

                // å–æ¶ˆä¹‹å‰çš„ç›£è½
                if (unsubscribeReservations) unsubscribeReservations();
                if (unsubscribeInstruments) unsubscribeInstruments();

                // ç›£è½é ç´„è³‡æ–™
                unsubscribeReservations = listenToReservations((data) => {
                    log('ğŸ“Š é ç´„è³‡æ–™å·²æ›´æ–°', 'success');
                    displayData(data, 'å³æ™‚é ç´„è³‡æ–™');
                });

                // ç›£è½å„€å™¨è³‡æ–™
                unsubscribeInstruments = listenToInstruments((data) => {
                    log('ğŸ”§ å„€å™¨è³‡æ–™å·²æ›´æ–°', 'success');
                });

                updateStatus('âœ… é–‹å§‹ç›£è½è³‡æ–™è®ŠåŒ–', 'success');

            } catch (error) {
                log(`ç›£è½è³‡æ–™å¤±æ•—: ${error.message}`, 'error');
                updateStatus('âŒ ç›£è½è³‡æ–™å¤±æ•—', 'error');
            }
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
            document.getElementById('dataContent').innerHTML = 'ç­‰å¾…è³‡æ–™...';
        }

        // å°‡å‡½æ•¸è¨­ç‚ºå…¨åŸŸï¼Œä¾›æŒ‰éˆ•ä½¿ç”¨
        window.testConnection = testConnection;
        window.writeTestData = writeTestData;
        window.readTestData = readTestData;
        window.listenToData = listenToData;
        window.clearLog = clearLog;

        // é é¢è¼‰å…¥æ™‚é¡¯ç¤ºç‹€æ…‹
        updateStatus('æº–å‚™å°±ç·’ï¼Œé»æ“ŠæŒ‰éˆ•é–‹å§‹æ¸¬è©¦', 'info');
    </script>
</body>
</html>

