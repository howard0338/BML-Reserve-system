<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Realtime Database 測試</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .status { padding: 15px; margin: 10px 0; border-radius: 5px; font-weight: bold; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        #log { background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 20px; font-family: monospace; white-space: pre-wrap; max-height: 500px; overflow-y: auto; }
        .data-display { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>🔥 Firebase Realtime Database 測試</h1>
    
    <div id="status" class="status info">準備中...</div>
    
    <div>
        <button onclick="testConnection()">🔗 測試連接</button>
        <button onclick="writeTestData()">✍️ 寫入測試資料</button>
        <button onclick="readTestData()">📖 讀取測試資料</button>
        <button onclick="listenToData()">👂 監聽資料變化</button>
        <button onclick="clearLog()">🗑️ 清除日誌</button>
    </div>
    
    <div id="dataDisplay" class="data-display">
        <h3>📊 資料顯示區域</h3>
        <div id="dataContent">等待資料...</div>
    </div>
    
    <div id="log"></div>

    <script type="module">
        import { 
            db, 
            auth, 
            ref, 
            set, 
            get, 
            onValue, 
            push, 
            remove, 
            signInAnonymously, 
            onAuthStateChanged,
            writeReservation,
            readAllReservations,
            listenToReservations,
            writeInstruments,
            readInstruments,
            listenToInstruments
        } from './firebase.js';

        let unsubscribeReservations = null;
        let unsubscribeInstruments = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '❌' : type === 'success' ? '✅' : type === 'warning' ? '⚠️' : 'ℹ️';
            logDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        function displayData(data, title) {
            const dataContent = document.getElementById('dataContent');
            dataContent.innerHTML = `
                <h4>${title}</h4>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
        }

        async function testConnection() {
            try {
                log('開始測試Firebase連接...');
                updateStatus('測試連接中...', 'info');

                // 測試認證
                const user = await new Promise((resolve, reject) => {
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            resolve(user);
                        } else {
                            signInAnonymously(auth).then(() => {
                                // 等待認證完成
                                setTimeout(() => {
                                    onAuthStateChanged(auth, (user) => {
                                        if (user) resolve(user);
                                        else reject(new Error('認證失敗'));
                                    });
                                }, 1000);
                            }).catch(reject);
                        }
                    });
                });

                log(`認證成功！用戶ID: ${user.uid}`, 'success');
                
                // 測試資料庫連接
                const testRef = ref(db, 'test');
                await set(testRef, { 
                    message: 'Hello Firebase!', 
                    timestamp: new Date().toISOString(),
                    user: user.uid 
                });
                
                const snapshot = await get(testRef);
                if (snapshot.exists()) {
                    log('資料庫連接成功！', 'success');
                    displayData(snapshot.val(), '測試資料');
                    updateStatus('✅ Firebase連接正常', 'success');
                } else {
                    throw new Error('無法讀取測試資料');
                }

            } catch (error) {
                log(`連接測試失敗: ${error.message}`, 'error');
                updateStatus('❌ Firebase連接失敗', 'error');
            }
        }

        async function writeTestData() {
            try {
                log('開始寫入測試資料...');
                updateStatus('寫入資料中...', 'info');

                // 寫入測試預約
                const reservationData = {
                    instrument: '測試儀器',
                    date: new Date().toISOString().split('T')[0],
                    timeSlot: '上午',
                    contactName: '測試用戶',
                    contactPhone: '0912345678',
                    notes: '這是一個測試預約'
                };

                const reservationId = await writeReservation(reservationData);
                log(`預約資料已寫入，ID: ${reservationId}`, 'success');

                // 寫入測試儀器
                const instrumentsData = [
                    {
                        id: 'test-1',
                        name: '測試儀器1',
                        location: '測試實驗室A',
                        status: 'available'
                    },
                    {
                        id: 'test-2',
                        name: '測試儀器2',
                        location: '測試實驗室B',
                        status: 'available'
                    }
                ];

                await writeInstruments(instrumentsData);
                log('儀器資料已寫入', 'success');

                updateStatus('✅ 測試資料寫入成功', 'success');

            } catch (error) {
                log(`寫入測試資料失敗: ${error.message}`, 'error');
                updateStatus('❌ 寫入資料失敗', 'error');
            }
        }

        async function readTestData() {
            try {
                log('開始讀取測試資料...');
                updateStatus('讀取資料中...', 'info');

                // 讀取預約資料
                const reservations = await readAllReservations();
                log('預約資料讀取完成', 'success');
                displayData(reservations, '預約資料');

                // 讀取儀器資料
                const instruments = await readInstruments();
                log('儀器資料讀取完成', 'success');

                updateStatus('✅ 資料讀取成功', 'success');

            } catch (error) {
                log(`讀取測試資料失敗: ${error.message}`, 'error');
                updateStatus('❌ 讀取資料失敗', 'error');
            }
        }

        function listenToData() {
            try {
                log('開始監聽資料變化...');
                updateStatus('監聽資料中...', 'info');

                // 取消之前的監聽
                if (unsubscribeReservations) unsubscribeReservations();
                if (unsubscribeInstruments) unsubscribeInstruments();

                // 監聽預約資料
                unsubscribeReservations = listenToReservations((data) => {
                    log('📊 預約資料已更新', 'success');
                    displayData(data, '即時預約資料');
                });

                // 監聽儀器資料
                unsubscribeInstruments = listenToInstruments((data) => {
                    log('🔧 儀器資料已更新', 'success');
                });

                updateStatus('✅ 開始監聽資料變化', 'success');

            } catch (error) {
                log(`監聽資料失敗: ${error.message}`, 'error');
                updateStatus('❌ 監聽資料失敗', 'error');
            }
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
            document.getElementById('dataContent').innerHTML = '等待資料...';
        }

        // 將函數設為全域，供按鈕使用
        window.testConnection = testConnection;
        window.writeTestData = writeTestData;
        window.readTestData = readTestData;
        window.listenToData = listenToData;
        window.clearLog = clearLog;

        // 頁面載入時顯示狀態
        updateStatus('準備就緒，點擊按鈕開始測試', 'info');
    </script>
</body>
</html>

